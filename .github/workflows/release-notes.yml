name: 'ðŸ“¦ Update Release Notes'

# Add extra information to release notes, such as links to the VS Code Marketplace.

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Tag of the release to be updated.
        type: string
        required: true
  release:
    types:
      - published
  # push:
  #   # Sequence of patterns matched against refs/tags
  #   tags:
  #     - "v*" # Push events to matching v*, i.e. v1.0, v20.15.10
  workflow_call:
    inputs:
      ref:
        type: string
        required: true

permissions:
  actions: read
  checks: write
  contents: write
  issues: read
  packages: write
  pull-requests: read
  repository-projects: read
  statuses: read

jobs:
  build:
    name: Update Release Notes
    env:
      REF: ${{ inputs.ref || github.ref }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ env.REF }}

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          # This is to match the node runner version, not necessarily the extension's target version
          node-version: 24.x
          cache: npm

      - name: Read package.json File
        id: package-json
        uses: streetsidesoftware/actions/public/read-file@v1
        with:
          # Relative to the root of the repository
          path: 'package.json'

      - name: CSpell Version
        id: cspell-version
        uses: streetsidesoftware/actions/public/output@v1
        with:
          value: ${{ fromJson(steps.package-json.outputs.result).dependencies['@cspell/cspell-types'] }}

      - name: VSCode Engine Version
        id: vscode-version
        uses: streetsidesoftware/actions/public/output@v1
        with:
          value: ${{ fromJson(steps.package-json.outputs.result).engines.vscode }}

      - name: Extension Version
        id: extension-version
        uses: streetsidesoftware/actions/public/output@v1
        with:
          value: ${{ fromJson(steps.package-json.outputs.result).version }}

      - name: Is PreRelease
        id: is-prerelease
        uses: streetsidesoftware/actions/public/output@v1
        with:
          value: ${{ fromJson(steps.package-json.outputs.result).vsce.prerelease && '**Prerelease**' || '' }}

      - name: VSCode Version Table
        id: version-table
        uses: streetsidesoftware/actions/public/output@v1
        with:
          value: |
            | Extension Version | VSCode Version | CSpell Version | Notes |
            | ----------------- | -------------- | -------------- | ---------- |
            | ${{ steps.extension-version.outputs.value }} | ${{ steps.vscode-version.outputs.value }} | ${{ steps.cspell-version.outputs.value }} | ${{ steps.is-prerelease.outputs.value }} |

      - name: Get Release
        id: release
        uses: actions/github-script@v8
        env:
          TAG: ${{ env.REF }}
        with:
          script: |
            const tag = process.env.TAG;
            const result = await github.request('GET /repos/{owner}/{repo}/releases/tags/{tag}', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tag,
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });
            return result.data;

      - name: Get Release ID
        id: release-id
        uses: streetsidesoftware/actions/public/output@v1
        with:
          value: ${{ fromJson(steps.release.outputs.result).id }}

      - name: Update Release Notes
        id: release-notes
        uses: actions/github-script@v8
        env:
          RELEASE: ${{ steps.release.outputs.result }}
          VERSION_TABLE: ${{ steps.version-table.outputs.value }}
        with:
          result-encoding: string
          script: |
            const release = JSON.parse(process.env.RELEASE);
            let body = release.body;
            let tableAt = body.length;
            const tableMarker = '<!-- RELEASE NOTES VERSION TABLE -->';
            if (body.includes(tableMarker)) {
              const beforeTable = body.split(tableMarker)[0];
              const afterTable = body.split(tableMarker)[1].split(tableMarker)[1];
              body = `${beforeTable}${tableMarker}`;
              tableAt = beforeTable.length;
            }

            body = body.slice(0, tableAt).trimEnd() + '\n\n' +
              tableMarker + '\n\n' +
              process.env.VERSION_TABLE.trim() + '\n\n' +
              tableMarker + '\n\n' +
              body.slice(tableAt).trimStart();
            return body;

      - name: Patch Release Notes
        id: patch-release-notes
        uses: actions/github-script@v8
        env:
          RELEASE: ${{ steps.release.outputs.result }}
          BODY: ${{ steps.release-notes.outputs.result }}
        with:
          result-encoding: string
          script: |
            const release = JSON.parse(process.env.RELEASE);
            const updatedBody = process.env.BODY;
            const release_id = release.id;
            const result = await github.request('PATCH /repos/{owner}/{repo}/releases/{release_id}', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release_id,
              tag_name: release.tag_name,
              target_commitish: release.target_commitish,
              name: release.name,
              body: updatedBody,
              draft: release.draft,
              prerelease: release.prerelease,
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });
            return result.data.body;

      - name: Summary
        uses: streetsidesoftware/actions/public/summary@v1
        with:
          text: |
            # Summary

            ## Version Information

            ${{ steps.version-table.outputs.value }}

            ## Release ID

            ${{ steps.release-id.outputs.result }}

            # Release Notes

            ${{ steps.release-notes.outputs.result }}
